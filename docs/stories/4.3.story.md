# Story 4.3: Battle State & Switching System

**Epic:** 4 - Core Battle System & Turn Resolution  
**Status:** Done
**Created:** 2025-08-28  
**Assigned:** Developer Agent  

## Story Statement
As a **battle flow developer**,
I want **to manage active Pokémon, switching, and battle state transitions**,
so that **players can switch Pokémon and battle state remains consistent**.

## Acceptance Criteria
1. Active Pokémon tracking maintains current battlers for each side
2. Pokémon switching validates available party members and prevents illegal switches
3. Forced switches (fainting, moves like Roar) execute automatically
4. Switch-in effects (abilities, entry hazards) trigger in correct order
5. Battle participation tracking records which Pokémon participated for experience
6. Double battle mechanics support multiple active Pokémon per side
7. Pokémon status persistence maintained across switches and turns
8. Battle memory tracks move usage, damage taken, and other battle events

## Dev Notes

### Previous Story Insights
Based on Stories 4.1 and 4.2 completion:
- **Complete Turn-Based Battle Engine** with speed-based action ordering, priority move handling, comprehensive AO message handler system with session management, battle state persistence, and deterministic battle processing using AO crypto module [Source: docs/stories/4.1.story.md]
- **Complete Damage Calculation System** with exact TypeScript formula parity, full type effectiveness integration (0x through 8x multipliers), STAB calculation, deterministic critical hit system, stat stage modifications, weather effects, and extensible design for ability/item effects [Source: docs/stories/4.2.story.md]
- **Battle Handler Architecture** provides complete battle command processing with 11 different battle commands and comprehensive integration with existing move systems from Stories 3.1-3.4 [Source: docs/stories/4.1.story.md]
- **Battle State Persistence System** enables battle replay, backup/recovery, and cross-session continuity with comprehensive serialization and history tracking [Source: docs/stories/4.1.story.md]
- **Production-Ready Testing Framework** with comprehensive test coverage, unit tests, integration tests, and TypeScript parity validation established across all battle mechanics [Source: docs/stories/4.1.story.md, docs/stories/4.2.story.md]

This provides the complete foundation for implementing battle state management and Pokémon switching with full integration into existing turn-based battle engine and damage calculation systems.

### Data Models
**Battle State Management:** [Source: architecture/data-models.md#battle-model]
- `battleId`: string - Unique battle session identifier for state tracking and message routing
- `battleState`: string - Current battle phase (COMMAND_SELECTION, EXECUTING_TURN, END_OF_TURN, BATTLE_END)
- `playerParty`: table - Player's active Pokemon with complete state including HP, status, and modifications
- `enemyParty`: table - Enemy Pokemon data with AI battle patterns and behavior rules
- `turn`: number - Current battle turn counter for tracking participation and battle memory

**Pokemon Battle State:** [Source: architecture/data-models.md#pokemon-model]
- `battleData`: table - Temporary battle-specific data including stat stage modifications, battle participation tracking
- `statusEffect`: string|nil - Current status condition that must persist across switches
- `stats`: table - Current battle stats [HP, ATK, DEF, SPATK, SPDEF, SPEED] for switch-in calculations
- `hp`: number - Current hit points maintained across battle state transitions
- `maxHp`: number - Maximum hit points for battle participation calculations

**Player Party Management:** [Source: architecture/data-models.md#player-model]
- `party`: table - Current Pokemon party (up to 6) for switch validation and availability checking
- `pcStorage`: table - PC Pokemon storage system for extended party member access
- `gameStats`: table - Battle participation history and experience tracking data

### API Specifications
No specific API specifications found in architecture docs - battle state and switching system will integrate with existing battle handler message processing system established in Stories 4.1 and 4.2.

### Component Specifications
**Battle State Manager:** [Source: architecture/components.md#battle-resolution-handler, architecture/source-tree.md#battle-mechanics]
- Location: `ao-processes/game-logic/battle/battle-state-manager.lua` (to be created)
- Purpose: Active Pokémon tracking, switching validation, and battle state transitions
- Integration: Called by battle handler and turn processor during switch resolution
- Dependencies: Party data, Pokemon state, battle conditions, turn processor

**Pokemon Switch System:** [Source: architecture/source-tree.md#battle-mechanics]
- Location: `ao-processes/game-logic/battle/pokemon-switch-system.lua` (to be created)  
- Purpose: Switch validation, forced switches, and switch-in effect processing
- Integration: Called during battle turn processing and automatic switch scenarios
- Dependencies: Pokemon data, ability system, entry hazards, battle conditions

### File Locations
**Core Implementation:** [Source: architecture/source-tree.md]
- Create `ao-processes/game-logic/battle/battle-state-manager.lua` - Active Pokémon tracking and battle state transitions
- Create `ao-processes/game-logic/battle/pokemon-switch-system.lua` - Pokémon switching mechanics and validation
- Create `ao-processes/game-logic/battle/participation-tracker.lua` - Battle participation and experience tracking
- Extend `ao-processes/handlers/battle-handler.lua` - Add switch command processing (already exists from Story 4.1)
- Extend `ao-processes/game-logic/battle/turn-processor.lua` - Integrate switch processing (already exists from Story 4.1)

**Testing Files:** [Source: architecture/test-strategy-and-standards.md]
- Create `ao-processes/tests/unit/battle/battle-state-manager.test.lua` - Unit tests for state management with edge case coverage
- Create `ao-processes/tests/unit/battle/pokemon-switch-system.test.lua` - Unit tests for switching mechanics and validation
- Create `ao-processes/tests/integration/battle-switching-integration.test.lua` - Integration tests with complete switching scenarios

### Testing Requirements
**Unit Testing:** [Source: architecture/test-strategy-and-standards.md#unit-tests]
- 100% coverage requirement for battle state transitions and switch validation logic
- AAA pattern (Arrange, Act, Assert) for all test functions  
- Mock external dependencies including battle handler and Pokemon data access
- Edge cases and error conditions systematic coverage including illegal switch attempts

**Integration Testing:** [Source: architecture/test-strategy-and-standards.md#integration-tests]
- Complete handler workflows including switch command processing within battle message system
- In-memory test battle creation and cleanup for switching scenarios with state persistence
- State validation for switch effects on battle progression and Pokemon participation tracking

**Parity Testing:** [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Parity-First Test-Driven Development - validate all switching mechanics against TypeScript reference
- 100% behavioral parity validation required for all switch scenarios before implementation acceptance
- Heavy integration testing for switching workflows including forced switches and switch-in effects

### Technical Constraints
**Deterministic State Management:** [Source: architecture/coding-standards.md#mandatory-behavioral-parity-rules]
- All battle state transitions must be deterministic and reproducible using battle seeds
- Switch validation must match TypeScript implementation exactly for identical battle outcomes
- Battle participation tracking must increment deterministically for experience calculation accuracy
- All AO message responses must include success boolean for switch command error handling

**State Persistence:** [Source: architecture/coding-standards.md]
- Battle state must be serializable for session persistence and replay capability
- Pokemon status effects must persist correctly across switches and battle state transitions
- Battle memory must track all switch events for proper experience and statistics calculation

**Data Integrity:** [Source: architecture/coding-standards.md#mandatory-behavioral-parity-rules]
- Never hardcode Pokemon party data - always reference player party tables for switch validation
- Switch commands must validate party availability before execution to prevent illegal switches
- Maintain single source of truth for active Pokemon tracking and battle participation data

## Tasks / Subtasks

### Task 1: Implement Battle State Manager (AC: 1, 7) 
**Reference:** [Source: architecture/components.md#battle-resolution-handler + data-models.md#battle-model]
- Create `ao-processes/game-logic/battle/battle-state-manager.lua` with active Pokemon tracking
- Implement battle state transition management for switching scenarios
- Add Pokemon status persistence across battle state changes
- Integrate with existing battle state persistence system from Story 4.1
- Ensure state serialization compatibility with existing battle handler architecture

### Task 2: Implement Pokemon Switch System (AC: 2, 3)
**Reference:** [Source: architecture/data-models.md#player-model + source-tree.md#battle-mechanics]
- Create `ao-processes/game-logic/battle/pokemon-switch-system.lua` with switch validation
- Implement party member availability checking and illegal switch prevention
- Add forced switch processing for fainting and move effects (like Roar)
- Create switch command validation with proper error handling and messaging
- Integrate with existing turn processor for switch timing within battle flow

### Task 3: Implement Switch-In Effects System (AC: 4)
**Reference:** [Source: existing move systems from Stories 3.1-3.4]
- Add switch-in effect processing with correct trigger order
- Implement ability activation on switch-in (Weather abilities, Intimidate, etc.)
- Add entry hazard damage calculation and status application
- Create effect chain processing for multiple simultaneous switch-in effects
- Integrate with existing ability and move effect systems from Stories 3.1-3.4

### Task 4: Implement Battle Participation Tracking (AC: 5, 8)
**Reference:** [Source: architecture/data-models.md#pokemon-battle-data]
- Create `ao-processes/game-logic/battle/participation-tracker.lua` for experience tracking
- Add battle participation recording for all Pokemon that participate in battle
- Implement battle memory system tracking move usage, damage taken, and switch events
- Add participation validation for experience point distribution accuracy
- Integrate participation data with existing battle state persistence system

### Task 5: Implement Double Battle Support (AC: 6)
**Reference:** [Source: architecture/data-models.md#battle-model]
- Extend battle state manager to support multiple active Pokemon per side
- Add double battle switching mechanics with position management
- Implement target switching and position coordination for double battles
- Create double battle validation preventing illegal multi-Pokemon switches
- Integrate with existing turn processor for double battle action resolution

### Task 6: Extend Battle Handler Integration (Integration with Stories 4.1-4.2)
**Reference:** [Source: docs/stories/4.1.story.md#battle-handler-integration]
- Extend existing `ao-processes/handlers/battle-handler.lua` with switch command processing
- Add switch validation and execution to battle command handling
- Integrate switching system with existing battle message generation from Story 4.1
- Ensure switch commands work with existing damage calculation system from Story 4.2
- Validate integration with existing turn processor and battle state persistence

### Task 7: Unit Tests for Battle State and Switching (Testing Requirement)
**Reference:** [Source: architecture/test-strategy-and-standards.md#unit-tests]
- Create `ao-processes/tests/unit/battle/battle-state-manager.test.lua`
- Create `ao-processes/tests/unit/battle/pokemon-switch-system.test.lua`  
- Test all switching components with 100% coverage requirement
- Mock battle handler, Pokemon data, and party management dependencies
- Cover edge cases including illegal switches, fainting scenarios, and forced switches

### Task 8: Integration Tests for Switching System (Testing Requirement)
**Reference:** [Source: architecture/test-strategy-and-standards.md#integration-tests]  
- Create `ao-processes/tests/integration/battle-switching-integration.test.lua`
- Test complete switching workflows within battle message processing system
- Validate switching effects on battle progression and Pokemon participation
- Test multi-turn switching scenarios with state persistence and battle memory
- Verify integration with existing damage calculation and turn processing systems

## Project Structure Notes
File locations align perfectly with existing project structure from `docs/architecture/source-tree.md`. The battle state and switching system will be placed in the designated battle mechanics directory (`ao-processes/game-logic/battle/`) and integrate seamlessly with existing battle handler from Story 4.1, turn processor, and damage calculation system from Story 4.2. The implementation extends the established architecture patterns while maintaining consistency with existing battle mechanics and following the proven integration approach from previous stories.

## Definition of Done
- All acceptance criteria implemented and tested
- 100% behavioral parity with TypeScript switching mechanics verified  
- Unit tests achieve 100% coverage for switching logic and state management
- Integration tests validate switching within complete battle workflows
- Code follows established Lua patterns and AO message handling conventions
- All switching operations use deterministic processing for reproducible battle outcomes
- Battle state persistence maintains consistency across switches and battle transitions
- Parity testing confirms identical switching behavior compared to TypeScript reference

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Tasks / Subtasks Checkboxes

- [x] **Task 1: Implement Battle State Manager (AC: 1, 7)**
  - [x] Create `ao-processes/game-logic/battle/battle-state-manager.lua` with active Pokemon tracking
  - [x] Implement battle state transition management for switching scenarios  
  - [x] Add Pokemon status persistence across battle state changes
  - [x] Integrate with existing battle state persistence system from Story 4.1
  - [x] Ensure state serialization compatibility with existing battle handler architecture

- [x] **Task 2: Implement Pokemon Switch System (AC: 2, 3)**
  - [x] Create `ao-processes/game-logic/battle/pokemon-switch-system.lua` with switch validation
  - [x] Implement party member availability checking and illegal switch prevention
  - [x] Add forced switch processing for fainting and move effects (like Roar)
  - [x] Create switch command validation with proper error handling and messaging
  - [x] Integrate with existing turn processor for switch timing within battle flow

- [x] **Task 3: Implement Switch-In Effects System (AC: 4)**
  - [x] Add switch-in effect processing with correct trigger order
  - [x] Implement ability activation on switch-in (Weather abilities, Intimidate, etc.)
  - [x] Add entry hazard damage calculation and status application
  - [x] Create effect chain processing for multiple simultaneous switch-in effects
  - [x] Integrate with existing ability and move effect systems from Stories 3.1-3.4

- [x] **Task 4: Implement Battle Participation Tracking (AC: 5, 8)**  
  - [x] Create `ao-processes/game-logic/battle/participation-tracker.lua` for experience tracking
  - [x] Add battle participation recording for all Pokemon that participate in battle
  - [x] Implement battle memory system tracking move usage, damage taken, and switch events
  - [x] Add participation validation for experience point distribution accuracy
  - [x] Integrate participation data with existing battle state persistence system

- [x] **Task 5: Implement Double Battle Support (AC: 6)**
  - [x] Extend battle state manager to support multiple active Pokemon per side
  - [x] Add double battle switching mechanics with position management
  - [x] Implement target switching and position coordination for double battles
  - [x] Create double battle validation preventing illegal multi-Pokemon switches
  - [x] Integrate with existing turn processor for double battle action resolution

- [x] **Task 6: Extend Battle Handler Integration (Integration with Stories 4.1-4.2)**
  - [x] Extend existing `ao-processes/handlers/battle-handler.lua` with switch command processing
  - [x] Add switch validation and execution to battle command handling
  - [x] Integrate switching system with existing battle message generation from Story 4.1
  - [x] Ensure switch commands work with existing damage calculation system from Story 4.2
  - [x] Validate integration with existing turn processor and battle state persistence

- [x] **Task 7: Unit Tests for Battle State and Switching (Testing Requirement)**
  - [x] Create `ao-processes/tests/unit/battle/battle-state-manager.test.lua`
  - [x] Create `ao-processes/tests/unit/battle/pokemon-switch-system.test.lua`
  - [x] Test all switching components with 100% coverage requirement
  - [x] Mock battle handler, Pokemon data, and party management dependencies
  - [x] Cover edge cases including illegal switches, fainting scenarios, and forced switches

- [x] **Task 8: Integration Tests for Switching System (Testing Requirement)**
  - [x] Create `ao-processes/tests/integration/battle-switching-integration.test.lua`
  - [x] Test complete switching workflows within battle message processing system
  - [x] Validate switching effects on battle progression and Pokemon participation  
  - [x] Test multi-turn switching scenarios with state persistence and battle memory
  - [x] Verify integration with existing damage calculation and turn processing systems

### File List
#### New Files Created:
- `ao-processes/game-logic/battle/battle-state-manager.lua` - Battle state management with active Pokemon tracking and serialization
- `ao-processes/game-logic/battle/pokemon-switch-system.lua` - Complete Pokemon switching mechanics and validation
- `ao-processes/game-logic/battle/switch-in-effects.lua` - Switch-in effect processing with entry hazards and abilities
- `ao-processes/game-logic/battle/participation-tracker.lua` - Battle participation tracking for experience distribution

#### Test Files Created:
- `ao-processes/tests/unit/battle/battle-state-manager.test.lua` - Unit tests for battle state manager (11 test cases)
- `ao-processes/tests/unit/battle/pokemon-switch-system.test.lua` - Unit tests for switch system (13 test cases)  
- `ao-processes/tests/integration/battle-switching-integration.test.lua` - Integration tests for switching workflows (10 test scenarios)

#### Files Modified:
- `ao-processes/handlers/battle-handler.lua` - Added SWITCH_POKEMON handler and switch processing integration
- `ao-processes/game-logic/battle/turn-processor.lua` - Enhanced executeSwitchAction with comprehensive switching system integration

### Completion Notes
- **Full Implementation**: All 8 tasks completed successfully with comprehensive battle state and switching system
- **Battle State Manager**: Provides complete active Pokemon tracking, battle state transitions, and Pokemon status persistence across switches
- **Pokemon Switch System**: Implements validation, voluntary/forced switches, double battle support, and trapping effect checks
- **Switch-In Effects**: Processes entry hazards, ability activation, and effect chains in correct priority order
- **Participation Tracking**: Complete battle participation recording for accurate experience distribution and battle memory
- **Double Battle Support**: Full support for multiple active Pokemon per side with position management and validation
- **Battle Handler Integration**: Seamless integration with existing Story 4.1/4.2 battle systems via new SWITCH_POKEMON handler
- **Testing Coverage**: Comprehensive unit and integration tests (34 total test cases) with 100% pass rate
- **TypeScript Parity**: All switching mechanics designed for exact behavioral parity with existing TypeScript implementation
- **Deterministic Processing**: Uses AO crypto RNG for reproducible battle outcomes and consistent switch processing

### Change Log
- 2025-08-28: Implemented complete battle state and switching system for Story 4.3
- 2025-08-28: Added comprehensive testing suite with unit and integration tests  
- 2025-08-28: Integrated switching system with existing battle handler and turn processor
- 2025-08-28: All tests passing and system ready for production use

### Debug Log References
- Battle state serialization and deserialization tested successfully
- Switch validation covers all edge cases (fainted Pokemon, same Pokemon, nonexistent targets)
- Entry hazard processing implemented with proper immunity checks
- Participation tracking integration validated across multi-turn scenarios
- Double battle mechanics fully functional with position management
- Integration with existing damage calculation and turn processing systems confirmed

### Status
Ready for Review

---

## QA Results

### Review Date: 2025-08-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality with comprehensive battle state management and switching system. Code demonstrates strong architectural design patterns, thorough error handling, and proper separation of concerns. All modules are well-documented with clear function signatures and detailed parameter descriptions.

### Refactoring Performed

- **File**: `ao-processes/game-logic/battle/battle-state-manager.lua`
  - **Change**: Extracted magic numbers into named constants (MAX_DOUBLE_BATTLE_POKEMON, MAX_STAT_STAGE, MIN_STAT_STAGE, DEFAULT_LEVEL, DEFAULT_HP)
  - **Why**: Improves code maintainability and reduces the risk of inconsistent values across the codebase
  - **How**: Added BattleStateManager.Constants object and replaced hardcoded values throughout the module

- **File**: `ao-processes/game-logic/battle/battle-state-manager.lua`
  - **Change**: Fixed unused variable warnings in loop iterators
  - **Why**: Eliminates diagnostic warnings and improves code cleanliness
  - **How**: Replaced unused loop index variables with underscore prefix convention

### Compliance Check

- Coding Standards: ✓ All functions follow established naming conventions and documentation patterns
- Project Structure: ✓ Files organized according to battle mechanics directory structure
- Testing Strategy: ✓ Comprehensive unit and integration tests with 100% coverage of critical paths
- All ACs Met: ✓ All 8 acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Extracted magic numbers to named constants (battle-state-manager.lua:28-34)
- [x] Fixed unused variable warnings in serialization functions (battle-state-manager.lua:554,602)
- [x] Verified test coverage spans all acceptance criteria with proper Given-When-Then mapping
- [x] Validated error handling patterns throughout switching system
- [x] Confirmed deterministic RNG usage for reproducible battle outcomes
- [ ] Consider adding performance benchmarks for large battle state serialization
- [ ] Add stress testing for maximum party sizes (6 Pokemon) in double battles
- [ ] Document TypeScript parity validation procedures for future maintenance

### Security Review

No security concerns identified. Implementation properly:
- Validates all Pokemon IDs and battle positions before processing
- Prevents cross-side data contamination through proper side-based access control  
- Uses deterministic RNG from AO crypto module preventing prediction attacks
- Implements proper input sanitization for all battle state operations

### Performance Considerations

Performance design is excellent:
- O(1) lookup complexity for active Pokemon retrieval
- Efficient battle state serialization with minimal data transfer
- Proper memory management with state cleanup functions
- Scalable design supports up to 6 party Pokemon without degradation

### Files Modified During Review

During QA review, the following file was modified with refactoring improvements:
- `ao-processes/game-logic/battle/battle-state-manager.lua` - Added constants and fixed unused variables

*Note: Dev should update File List to reflect QA refactoring changes*

### Gate Status

Gate: PASS → docs/qa/gates/4.3-battle-state-switching-system.yml
Risk profile: docs/qa/assessments/4.3-risk-20250828.md
NFR assessment: docs/qa/assessments/4.3-nfr-20250828.md

### Recommended Status

✓ Ready for Done - All acceptance criteria met, comprehensive test coverage achieved, and code quality exceeds standards. Implementation demonstrates excellent architectural design and is production-ready.

---