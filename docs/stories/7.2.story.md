# Story 7.2: Pokémon Evolution System

**Epic:** 7 - Player Progression & Experience Systems  
**Status:** Draft
**Created:** 2025-09-02  
**Assigned:** Developer Agent  

## Story Statement
As a **evolution specialist**,
I want **to implement all evolution methods and conditions with proper triggering**,
so that **Pokémon evolve using identical conditions and timing to current game**.

## Acceptance Criteria
1. Level-based evolution triggers at correct levels during level-up process
2. Stone-based evolution validates item usage and species compatibility
3. Trade-based evolution handles evolution conditions properly
4. Friendship-based evolution checks friendship thresholds and timing conditions
5. Time-based evolution considers day/night cycles and time restrictions
6. Location-based evolution validates current biome/area requirements
7. Move-based evolution checks known moves during evolution trigger
8. Evolution cancellation (pressing B) prevents unwanted evolution properly

## Dev Notes

### Previous Story Insights
Key learnings from previous story (7.1 - Experience & Leveling System):
- **Evolution System Foundation**: A basic evolution system was created in `ao-processes/game-logic/pokemon/evolution-system.lua` with level-based evolution checking
- **Integration Pattern**: Evolution system integrated with experience system and battle handler through the `checkLevelEvolution()` function
- **Testing Infrastructure**: Comprehensive test framework established with unit tests and integration tests - must extend existing test suites
- **Behavioral Parity**: All evolution calculations must match TypeScript reference implementation exactly using deterministic processing
- **Data Dependencies**: Evolution chain data established in `ao-processes/data/species/evolution-chains.lua` - migrate complete dataset from TypeScript reference covering all 900+ Pokemon species and all evolution condition types

### Data Models
**Pokemon Model Evolution Data** [Source: architecture/data-models.md#pokemon-model]:
- `speciesId`: string - Species identifier from SpeciesId enum
- `level`: number - Current Pokemon level for evolution conditions
- `friendship`: number - Friendship level for friendship-based evolution
- `gender`: string - Gender for gender-specific evolutions
- `heldItem`: string|nil - Currently held item for item-based evolution
- `moves`: table - Array of known moves for move-based evolution requirements
- `evolutionHistory`: table - Evolution tracking for validation

**Battle Model Evolution Context** [Source: architecture/data-models.md#battle-model]:
- `battleSeed`: string - Deterministic RNG seed for evolution randomness
- `battleType`: string - Battle context that may affect evolution conditions
- `turn`: number - Battle timing for time-sensitive evolution triggers

### API Specifications
No specific API endpoints found in architecture docs for evolution system - system will integrate with existing Pokemon State Manager and battle resolution handler.

### Component Specifications
**Pokemon State Manager Integration** [Source: architecture/components.md#pokemon-state-manager]:
- `evolvePokemon(pokemonId, evolutionId)` - Evolution processing with stat recalculation
- `createPokemon(speciesId, level, ivs, nature)` - Pokemon instantiation may need evolution form handling
- `recalculateStats(pokemonId)` - Stat recalculation after evolution with new base stats

**Battle Resolution Handler Integration** [Source: architecture/components.md#battle-resolution-handler]:
- `processBattleTurn(battleCommand)` - Battle context for evolution conditions (trade, item usage)
- Evolution triggers may occur during battle resolution or post-battle processing

### File Locations
**Primary Implementation** [Source: architecture/source-tree.md]:
- `ao-processes/game-logic/pokemon/evolution-system.lua` - Existing evolution system to be expanded with all evolution types
- `ao-processes/handlers/battle-handler.lua` - Integration for trade and item-based evolution triggers
- `ao-processes/handlers/state-handler.lua` - Pokemon state management for evolution processing

**Data Dependencies** [Source: architecture/source-tree.md]:
- `ao-processes/data/species/evolution-chains.lua` - Existing evolution data to be expanded with all evolution conditions
- `ao-processes/data/species/species-database.lua` - Species base stats and evolution relationships
- `ao-processes/data/items/item-database.lua` - Evolution stones and held items for evolution conditions
- `ao-processes/data/constants/enums.lua` - Evolution trigger enums and time/location constants

**Handler Integration** [Source: architecture/source-tree.md]:
- `ao-processes/handlers/game-management-handler.lua` - Item usage processing for stone evolution
- `ao-processes/handlers/query-handler.lua` - Evolution status queries for UI and agents

### Testing Requirements
**Unit Tests** [Source: architecture/test-strategy-and-standards.md#unit-tests]:
- Location: `ao-processes/tests/unit/pokemon/evolution-system.test.lua`  
- Coverage Requirement: 100% for evolution condition checking and processing
- Follow AAA pattern (Arrange, Act, Assert)
- Mock all external dependencies including item usage, friendship tracking, and time/location systems

**Integration Tests** [Source: architecture/test-strategy-and-standards.md#integration-tests]:
- Location: `ao-processes/tests/integration/evolution-integration.test.lua`
- Test complete evolution workflows with message processing and state updates
- Validate evolution integration with battle handler, item usage, and stat recalculation
- Test evolution cancellation and user choice handling

### Technical Constraints
**Behavioral Parity Requirements** [Source: architecture/coding-standards.md]:
- Never use Lua's math.random() - ALWAYS use AO crypto module for deterministic evolution processing
- All evolution calculations must match TypeScript implementation exactly
- Evolution stone compatibility checks must be precise - never approximate
- Never hardcode evolution data - always reference evolution chain database
- Evolution RNG must be deterministic and reproducible

**Technology Stack** [Source: architecture/tech-stack.md]:
- Lua 5.3 runtime with AO Handlers for message processing
- AO Crypto Module for deterministic randomness in evolution processing
- In-process Lua tables for evolution state management
- Embedded Lua structures for evolution chain and species data

## Tasks / Subtasks

### Task 0: Verify and Implement Missing System Dependencies (Prerequisites)
**Reference:** [Source: architecture dependencies verification]
- [ ] Verify time/day-night cycle system exists or implement minimal time system for evolution
- [ ] Verify biome/location system exists or implement minimal location tracking for evolution
- [ ] Create time system stub if needed: basic day/night cycle detection from battle context or game progression
- [ ] Create location system stub if needed: basic biome tracking from battle context and game state
- [ ] Verify item database contains all required evolution items or extend with missing evolution stones and items
- [ ] Document any system dependencies that need future implementation in subsequent stories
- [ ] Ensure dependency systems integrate properly with existing AO message handling patterns

### Task 1: Expand Stone-Based Evolution System (AC: 2)
**Reference:** [Source: architecture/source-tree.md#game-logic] 
- [ ] Expand `evolution-system.lua` with stone evolution validation functions
- [ ] Implement evolution stone compatibility checking using species database
- [ ] Add stone usage validation with item database integration
- [ ] Create stone evolution processing with stat recalculation
- [ ] Use AO crypto module for any randomness in stone evolution
- [ ] Reference item database for evolution stone availability and effects

### Task 2: Trade-Based Evolution Implementation (AC: 3)
**Reference:** [Source: architecture/components.md#battle-resolution-handler]
- [ ] Implement trade evolution condition checking
- [ ] Handle trade evolution with held item requirements
- [ ] Create trade simulation for single-player evolution triggers
- [ ] Integrate trade evolution with battle handler messaging
- [ ] Validate trade evolution conditions match TypeScript implementation

### Task 3: Friendship-Based Evolution System (AC: 4)
**Reference:** [Source: architecture/data-models.md#pokemon-model]
- [ ] Implement friendship threshold checking (220+ standard)
- [ ] Add day/night time-based friendship evolution variants
- [ ] Create friendship evolution validation with timing conditions
- [ ] Integrate with friendship tracking system from experience story
- [ ] Handle friendship evolution during level progression and other triggers

### Task 4: Time-Based Evolution Conditions (AC: 5)
**Reference:** [Source: architecture/data-models.md#battle-model]
- [ ] Implement day/night cycle detection for time-based evolution
- [ ] Add time restriction validation for dawn/dusk evolutions
- [ ] Create time-sensitive evolution checking functions
- [ ] Integrate time-based conditions with existing evolution triggers
- [ ] Ensure time calculations match game timing mechanics

### Task 5: Location-Based Evolution System (AC: 6)
**Reference:** [Source: architecture/data-models.md#battle-model]
- [ ] Implement biome/area validation for location-based evolution
- [ ] Add special location requirement checking (caves, magnetic fields, etc.)
- [ ] Create location evolution condition validation
- [ ] Integrate location checking with battle context and game progression
- [ ] Validate location requirements against current game state

### Task 6: Move-Based Evolution Requirements (AC: 7)
**Reference:** [Source: architecture/data-models.md#pokemon-model]
- [ ] Implement known move checking for move-based evolution
- [ ] Add move requirement validation during evolution processing
- [ ] Create move-specific evolution condition checking
- [ ] Integrate move validation with Pokemon moveset data
- [ ] Ensure move requirements match species evolution chain data

### Task 7: Evolution Cancellation System (AC: 8)
**Reference:** [Source: architecture/components.md#pokemon-state-manager]
- [ ] Implement evolution cancellation handling (B button equivalent for agent interaction)
- [ ] Add user choice processing for evolution decisions with agent preference configuration
- [ ] Create evolution prevention system with save state
- [ ] Integrate cancellation with message handling for user input and autonomous agent decisions
- [ ] Implement auto-evolution configuration for agents (always evolve, never evolve, or conditional)
- [ ] Validate cancellation behavior matches original game mechanics

### Task 8: Complete Evolution Data Migration and Validation (AC: 1-8)
**Reference:** [Source: architecture/source-tree.md#data]
- [ ] Extract complete evolution data from TypeScript reference: `src/data/balance/pokemon-evolutions.ts`
- [ ] Migrate ALL evolution chains for ALL 900+ Pokemon species to `evolution-chains.lua`
- [ ] Convert all evolution items from `EvolutionItem` enum to Lua item database integration
- [ ] Verify item database contains all required evolution items (50+ items) or extend with missing evolution stones and items
- [ ] Create evolution item compatibility layer if item database structure differs from TypeScript
- [ ] Implement evolution item usage mechanics if not present in existing handlers
- [ ] Implement all evolution condition types: level, stone, trade, friendship, time, location, move-based, special conditions
- [ ] Add comprehensive evolution validation functions for all evolution types
- [ ] Create evolution requirement text generation for UI covering all trigger types
- [ ] Implement evolution statistics and debugging functions for complete dataset
- [ ] Ensure 100% evolution data completeness matching TypeScript reference with no species excluded
- [ ] Implement data loading strategy for large evolution dataset (lazy loading vs. pre-loaded optimization)

### Task 9: Unit Tests for Evolution System Extensions (Testing Requirement)
**Reference:** [Source: architecture/test-strategy-and-standards.md#unit-tests]
- [ ] Expand `evolution-system.test.lua` with all evolution types
- [ ] Test stone evolution validation and processing
- [ ] Test trade evolution condition checking
- [ ] Test friendship evolution with time conditions
- [ ] Test location and move-based evolution requirements
- [ ] Test evolution cancellation handling
- [ ] Mock item database, friendship system, time/location services
- [ ] Cover edge cases including invalid conditions and missing data

### Task 10: Integration Tests for Complete Evolution System (Testing Requirement)
**Reference:** [Source: architecture/test-strategy-and-standards.md#integration-tests]
- [ ] Expand `evolution-integration.test.lua` with all evolution scenarios
- [ ] Test complete evolution workflows for all trigger types
- [ ] Validate evolution integration with item usage, friendship tracking, and time systems
- [ ] Test evolution cancellation within complete game workflows
- [ ] Test multiple evolution options and user choice handling
- [ ] Verify integration with existing battle handler and Pokemon state management

## Project Structure Notes
File locations align with existing project structure from `docs/architecture/source-tree.md`. The evolution system expansion builds on the foundation created in Story 7.1, extending the existing `ao-processes/game-logic/pokemon/evolution-system.lua` and `ao-processes/data/species/evolution-chains.lua` files. The implementation will integrate with item database for stone evolutions, friendship tracking for friendship evolution, and time/location systems for conditional evolution. The system extends the Pokemon State Manager and Battle Resolution Handler patterns established in previous stories while maintaining behavioral parity with TypeScript reference implementation.

## Definition of Done
- All system dependencies verified or minimal stubs implemented (time system, location system, item database)
- All acceptance criteria implemented and tested with 100% behavioral parity
- Complete evolution system supporting all 8 evolution trigger types from original game
- Stone, trade, friendship, time, location, and move-based evolution fully functional
- Evolution cancellation system properly handles user choice, agent preferences, and prevention
- Unit tests achieve 100% coverage for all evolution condition checking and processing
- Integration tests validate complete evolution workflows within game systems
- Code follows established Lua patterns and AO message handling conventions
- All evolution calculations use deterministic processing for reproducible outcomes
- Complete evolution data migration for ALL 900+ Pokemon species with 100% TypeScript reference parity
- Complete integration with existing Pokemon state manager, battle handler, and experience systems
- Evolution notifications and user interaction properly implemented
- All evolution items (50+ items) verified in item database or extended as needed

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References  
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-02 | 1.0 | Initial story creation for Pokémon Evolution System | BMad Story Creator |