name: Read Labels

on:
    workflow_run:
        workflows: ["Detect Labels"]
        types: [completed]

jobs:
    read-label-data:
        if: >
            github.event.workflow_run.event == 'pull_request' &&
            github.event.workflow_run.conclusion == 'success'
        runs-on: ubuntu-latest
        steps:
            - name: Download artifact
              uses: actions/github-script@v8.0.0
              with:
                  script: |
                      var artifacts = await github.actions.listWorkflowRunArtifacts({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: ${{github.event.workflow_run.id }},
                      });
                      var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                        return artifact.name == "pr"
                      })[0];
                      var download = await github.actions.downloadArtifact({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        artifact_id: matchArtifact.id,
                        archive_format: 'zip',
                      });
                      var fs = require('fs');
                      fs.writeFileSync('${{github.workspace}}/pr.zip', Buffer.from(download.data));
            - run: unzip pr.zip7
            - name: "Comment on PR"
              uses: actions/github-script@v3
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');
                      const issue_number = Number(fs.readFileSync('./NR'));
                      const label = fs.readFileSync('./LABEL').toString().trim();
                      await github.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue_number,
                        body: 'Added label: ' + label + ' to PR: ' + issue_number
                      });
